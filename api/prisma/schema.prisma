// ---------------------------------------------
// Prisma schema for RadiNate backend
// ---------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------
// Models
// ---------------------------------------------

model Study {
  id            Int      @id @default(autoincrement())
  study_uid     String   @unique
  accession     String?
  patient_age   Int?
  patient_sex   String?
  site_id       String?
  scanner_make  String?
  scanner_model String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  aiOutputs         AIOutput[]
  groundTruths      GroundTruth[]
  comparisonResults ComparisonResult[] // ✅ back relation
}

model AIOutput {
  id         Int      @id @default(autoincrement())
  study_id   Int
  finding    String
  confidence Float
  created_at DateTime @default(now())

  // Relation
  study Study @relation(fields: [study_id], references: [id], onDelete: Cascade)

  // Compound unique constraint so we can use upsert in seeds
  @@unique([study_id, finding], name: "study_id_finding")
}

model GroundTruth {
  id         Int      @id @default(autoincrement())
  study_id   Int
  finding    String
  created_at DateTime @default(now())

  // Relation
  study Study @relation(fields: [study_id], references: [id], onDelete: Cascade)

  // Compound unique constraint to prevent duplicate truth entries
  @@unique([study_id, finding], name: "study_id_finding")
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  action    String
  user      String?
  entity    String?
  entity_id Int?
  timestamp DateTime @default(now())
  payload   Json?     // ✅ added (to store job summaries or request bodies)
}

model ComparisonResult {
  id            Int       @id @default(autoincrement())
  job_id        String    @default(uuid())
  study_uid     String
  study_id      Int
  model_name    String?    // ✅ added
  model_version String?    // ✅ added
  precision     Float
  recall        Float
  f1_score      Float
  created_at    DateTime  @default(now())

  study Study? @relation(fields: [study_id], references: [id])
}

// -----------------------------
// Analytics Models for Radinate
// -----------------------------

model RunManifest {
  id            Int       @id @default(autoincrement())
  job_id        String    @default(uuid())
  model_name    String
  model_version String
  run_type      String    // e.g. "comparison", "drift", "fairness"
  started_at    DateTime  @default(now())
  completed_at  DateTime?
  status        String    // "running" | "success" | "failed"
  summary       Json?
}

model MetricsTimeSeries {
  id           Int      @id @default(autoincrement())
  model_name   String
  model_version String
  window       String
  precision    Float
  recall       Float
  f1_score     Float
  auc_roc      Float?
  auc_pr       Float?
  ppv          Float?
  npv          Float?
  prevalence   Float?
  ece          Float?
  n            Int?
  computed_at  DateTime @default(now())
}


model DriftMetric {
  id                Int      @id @default(autoincrement())
  model_name        String
  model_version     String
  window            String
  total_features    Int
  drifted_features  Int
  drift_rate        Float
  avg_p_value       Float
  created_at        DateTime @default(now())
}

model DriftSignal {
  id          Int      @id @default(autoincrement())
  model_name  String
  feature     String
  method      String
  p_value     Float
  diff        Float
  status      String
  window      String
  created_at  DateTime @default(now())
}

model FairnessMetric {
  id          Int      @id @default(autoincrement())
  model_name  String
  window      String
  subgroup    String
  precision   Float
  recall      Float
  f1_score    Float
  delta       Float
  created_at  DateTime @default(now())
}


model RBACUser {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  password    String   @default("changeme123")
  role_id     Int
  created_at  DateTime @default(now())
  role        RBACRole @relation(fields: [role_id], references: [id])
}

model RBACRole {
  id          Int           @id @default(autoincrement())
  name        String         @unique
  permissions RBACPermission[]
  users       RBACUser[]
}

model RBACPermission {
  id      Int      @id @default(autoincrement())
  role_id Int
  action  String
  role    RBACRole @relation(fields: [role_id], references: [id])
}

model Alert {
  id         Int      @id @default(autoincrement())
  type       String
  message    String
  severity   String   @default("info")
  ack_by     String?
  created_at DateTime @default(now())
}

